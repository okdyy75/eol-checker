# 実装計画: GitHub Pagesデプロイ

## 概要

EOLタイムラインビューアーアプリケーションをGitHub Pagesにデプロイするための実装計画です。Next.jsの静的エクスポート設定、GitHub Actionsワークフローの作成、テストの実装を段階的に進めます。

## タスク

- [x] 1. Next.js設定の更新
  - next.config.jsにベースパス設定を追加
  - 環境変数NEXT_PUBLIC_BASE_PATHからベースパスを読み取る
  - basePathとassetPrefixを設定
  - _要件: 2.1, 2.5, 5.2_

- [x] 2. GitHub Actionsワークフローの作成
  - [x] 2.1 データ更新ワークフローの作成
    - .github/workflows/update-eol-data.ymlを作成
    - スケジュールトリガー（毎週日曜日 0:00 UTC）
    - 手動実行トリガー（workflow_dispatch）
    - 必要な権限設定（contents: write）
    - Node.js環境のセットアップ（v20、npmキャッシュ有効化）
    - 依存関係のインストール（npm ci）
    - EOLデータの取得（npm run fetch-eol-data）
    - 変更の確認とコミット・プッシュ（[skip ci]付き）
    - _要件: 3.2, 3.3, 3.4_
  
  - [x] 2.2 デプロイワークフローの更新
    - .github/workflows/deploy.ymlを更新
    - mainブランチへのプッシュでトリガー（ドキュメント変更は除外）
    - 必要な権限設定（pages: write, id-token: write）
    - Node.js環境のセットアップ（v20、npmキャッシュ有効化）
    - 依存関係のインストール（npm ci）
    - EOLデータの存在確認ステップを追加
    - データ取得ステップを削除
    - Next.jsビルドキャッシュの設定
    - アプリケーションのビルド（NEXT_PUBLIC_BASE_PATH設定）
    - ビルド成果物のアップロード
    - _要件: 3.1, 3.2, 3.3, 3.5, 7.1, 7.2_
  
  - [x] 2.3 デプロイジョブの実装
    - GitHub Pagesへのデプロイ設定
    - デプロイURLの出力設定
    - _要件: 3.6, 6.2_

- [x] 3. チェックポイント - ワークフロー設定の確認
  - ワークフローファイルの構文が正しいことを確認
  - 必要に応じてユーザーに質問

- [ ] 4. 設定ファイルのテスト実装
  - [x] 4.1 Next.js設定のユニットテスト
    - 静的エクスポートモードの確認テスト
    - 画像最適化無効化の確認テスト
    - 末尾スラッシュ設定の確認テスト
    - ベースパス設定の確認テスト（環境変数あり/なし）
    - _要件: 1.1, 1.3, 1.4, 2.1, 2.4, 2.5_
  
  - [ ]* 4.2 デプロイワークフローのユニットテスト
    - mainブランチトリガーの確認テスト
    - ドキュメント変更除外の確認テスト
    - Node.jsセットアップステップの確認テスト
    - 依存関係キャッシュの確認テスト
    - EOLデータ存在確認ステップの確認テスト
    - データ取得ステップが存在しないことの確認テスト
    - ビルドステップの確認テスト
    - 環境変数設定の確認テスト
    - _要件: 3.1, 3.2, 3.3, 3.5, 7.1_
  
  - [ ]* 4.3 データ更新ワークフローのユニットテスト
    - スケジュールトリガーの確認テスト（cron: '0 0 * * 0'）
    - 手動実行トリガーの確認テスト（workflow_dispatch）
    - contents: write権限の確認テスト
    - データ取得ステップの確認テスト
    - 変更確認ステップの確認テスト
    - コミットメッセージに[skip ci]が含まれることの確認テスト
    - _要件: 3.2, 3.3, 3.4_

- [ ] 5. プロパティベーステストの実装
  - [ ]* 5.1 プロパティ1: ビルド成果物の完全性テスト
    - **プロパティ1: ビルド成果物の完全性**
    - outディレクトリに必須ファイル（index.html、_next、data）が存在することを検証
    - **検証要件: 1.2**
  
  - [ ]* 5.2 プロパティ2: アセット参照のベースパス適用テスト
    - **プロパティ2: アセット参照のベースパス適用**
    - 生成されたHTMLファイル内のすべてのアセット参照がベースパスを含むことを検証
    - 内部リンク、CSS、JavaScript、画像の参照をチェック
    - **検証要件: 2.2, 2.3, 4.3, 4.4**
  
  - [ ]* 5.3 プロパティ3: 不要ファイルの除外テスト
    - **プロパティ3: 不要ファイルの除外**
    - outディレクトリに開発用ファイルが含まれていないことを検証
    - .env、node_modules、ソースコードファイルなどの除外を確認
    - **検証要件: 7.4**

- [x] 6. チェックポイント - テスト実行
  - すべてのテストが成功することを確認
  - 必要に応じてユーザーに質問

- [x] 7. ドキュメンテーションの作成
  - [x] 7.1 READMEの更新
    - GitHub Pagesデプロイ手順を追加
    - 初期設定手順（リポジトリ設定でGitHub Pagesを有効化）
    - 環境変数の説明
    - ローカルでの静的エクスポートテスト方法
    - データ更新ワークフローの説明（週次自動実行と手動実行）
    - _要件: 9.1, 9.2_
  
  - [ ]* 7.2 カスタムドメイン設定ガイドの作成（オプション）
    - カスタムドメインの設定手順
    - CNAMEファイルの配置方法
    - _要件: 9.4_

- [x] 8. 最終チェックポイント
  - すべてのファイルが正しく作成されていることを確認
  - テストが成功していることを確認
  - ドキュメントが完成していることを確認
  - ユーザーに最終確認を求める

## 注意事項

- `*`マークのタスクはオプションで、MVPを早く完成させたい場合はスキップ可能です
- 各タスクは特定の要件を参照しており、トレーサビリティを確保しています
- チェックポイントで段階的な検証を行い、問題を早期に発見します
- プロパティベーステストは普遍的な正確性プロパティを検証します
- ユニットテストは特定の例とエッジケースを検証します
